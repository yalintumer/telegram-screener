// WaveTrend Screener - Buy Signal Indicator
// Combines: Stochastic RSI + MFI + WaveTrend
// Shows only BUY signals on chart
//
// Created by: @yalintumer
// Version: 4.0 (Fixed Stage 1 logic)

//@version=5
indicator("WaveTrend Screener", shorttitle="WTS", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Stochastic RSI
stoch_rsi_period = input.int(14, "RSI Period", group="Stochastic RSI")
stoch_period = input.int(14, "Stoch Period", group="Stochastic RSI")
stoch_k_smooth = input.int(3, "K Smoothing", group="Stochastic RSI")
stoch_d_smooth = input.int(3, "D Smoothing", group="Stochastic RSI")
stoch_oversold = input.float(20.0, "Oversold Level", group="Stochastic RSI")
require_sustained = input.bool(false, "Require K Rising 2 Days", tooltip="If true, K must be rising for 2 consecutive days at cross. Stricter but fewer signals.", group="Stochastic RSI")
require_d_stable = input.bool(true, "Require D Stable", tooltip="If true, D must not be crashing (falling >10%)", group="Stochastic RSI")

// MFI
mfi_length = input.int(14, "MFI Length", group="MFI")
mfi_uptrend_days = input.int(3, "Uptrend Days", group="MFI")

// WaveTrend
wt_channel = input.int(10, "Channel Length", group="WaveTrend")
wt_average = input.int(21, "Average Length", group="WaveTrend")
wt_oversold = input.float(-53.0, "Oversold Level", group="WaveTrend")

// Signal Settings
lookback = input.int(3, "Signal Lookback", group="Signals")

// Debug
show_debug = input.bool(false, "Show Debug Info", group="Debug")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCHASTIC RSI CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rsi_val = ta.rsi(close, stoch_rsi_period)
rsi_min = ta.lowest(rsi_val, stoch_period)
rsi_max = ta.highest(rsi_val, stoch_period)
stoch_raw = (rsi_val - rsi_min) / math.max(rsi_max - rsi_min, 0.0001)

// K and D lines (0-100 scale)
k_line = ta.sma(stoch_raw * 100, stoch_k_smooth)
d_line = ta.sma(k_line, stoch_d_smooth)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCHASTIC RSI BUY SIGNAL (Python exact match)
// 
// Python logic (indicators.py line 240-257):
// for i in range(1, lookback_days + 1):
//     idx = -i          # Current bar being checked
//     prev_idx = idx - 1  # Bar before that
//     prev_prev_idx = idx - 2  # Two bars before
//
// Example: i=1 â†’ idx=-1 (last bar), prev=-2, prev_prev=-3
//          i=2 â†’ idx=-2, prev=-3, prev_prev=-4
//
// In PineScript: [0]=current, [1]=1 bar ago, [2]=2 bars ago
// So Python idx=-1 = PineScript [0]
//    Python idx=-2 = PineScript [1]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Function to check Stoch RSI signal at a specific lookback position
// bars_back: 0 = current bar, 1 = 1 bar ago, etc.
stoch_rsi_buy(int bars_back) =>
    // Current bar (the one we're checking for cross)
    curr_k = k_line[bars_back]
    curr_d = d_line[bars_back]
    
    // Previous bar (before the cross)
    prev_k = k_line[bars_back + 1]
    prev_d = d_line[bars_back + 1]
    
    // Two bars back (for sustained momentum check)
    prev_prev_k = k_line[bars_back + 2]
    
    // 1. CROSS UP: K was at or below D, now K is above D
    cross_up = (prev_k <= prev_d) and (curr_k > curr_d)
    
    // 2. OVERSOLD: Either K or D is below 20 at the time of cross
    oversold = (curr_k < stoch_oversold) or (curr_d < stoch_oversold) or (prev_k < stoch_oversold) or (prev_d < stoch_oversold)
    
    // 3. SUSTAINED UPTREND: K has been rising for 2 consecutive bars (OPTIONAL)
    k_rising_today = curr_k > prev_k
    k_rising_yesterday = prev_k > prev_prev_k
    sustained = require_sustained ? (k_rising_today and k_rising_yesterday) : k_rising_today
    
    // 4. D NOT CRASHING: D is stable (not falling more than 10%) (OPTIONAL)
    d_stable = require_d_stable ? (curr_d >= prev_d * 0.9) : true
    
    // All conditions must be met
    cross_up and oversold and sustained and d_stable

// Check if signal occurred in lookback window
// Python: range(1, lookback_days + 1) means check bars 1, 2, 3 ago
// But we also want to check current bar (0), so we check 0, 1, 2
stoch_signal = false
for i = 0 to lookback - 1
    if stoch_rsi_buy(i)
        stoch_signal := true
        break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MFI UPTREND (Python exact match)
//
// Python logic (indicators.py line 65-91):
// for i in range(1, days + 1):
//     curr = mfi_series.iloc[-i]
//     prev = mfi_series.iloc[-i-1]
//     if curr <= prev:
//         return False
//
// Example with days=3:
//   i=1: curr=mfi[-1], prev=mfi[-2] â†’ mfi[-1] > mfi[-2]
//   i=2: curr=mfi[-2], prev=mfi[-3] â†’ mfi[-2] > mfi[-3]
//   i=3: curr=mfi[-3], prev=mfi[-4] â†’ mfi[-3] > mfi[-4]
//
// In PineScript:
//   mfi[0] > mfi[1] > mfi[2] > mfi[3]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mfi_val = ta.mfi(hlc3, mfi_length)

// Check if MFI has been rising for N consecutive days
mfi_uptrend = true
for i = 0 to mfi_uptrend_days - 1
    // mfi[i] must be greater than mfi[i+1]
    // i=0: mfi[0] > mfi[1] (today > yesterday)
    // i=1: mfi[1] > mfi[2] (yesterday > 2 days ago)
    // i=2: mfi[2] > mfi[3] (2 days ago > 3 days ago)
    if mfi_val[i] <= mfi_val[i + 1]
        mfi_uptrend := false
        break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVETREND CALCULATION & SIGNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ap = hlc3
esa = ta.ema(ap, wt_channel)
d_wt = ta.ema(math.abs(ap - esa), wt_channel)
ci = (ap - esa) / (0.015 * d_wt)
wt1 = ta.ema(ci, wt_average)
wt2 = ta.sma(wt1, 4)

// WaveTrend buy signal at specific lookback
wavetrend_buy(int bars_back) =>
    curr_wt1 = wt1[bars_back]
    curr_wt2 = wt2[bars_back]
    prev_wt1 = wt1[bars_back + 1]
    prev_wt2 = wt2[bars_back + 1]
    
    // Cross up
    cross_up = (prev_wt1 <= prev_wt2) and (curr_wt1 > curr_wt2)
    
    // Oversold at cross
    oversold = (curr_wt1 < wt_oversold) or (curr_wt2 < wt_oversold) or (prev_wt1 < wt_oversold) or (prev_wt2 < wt_oversold)
    
    cross_up and oversold

// Check lookback window
wt_signal = false
for i = 0 to lookback - 1
    if wavetrend_buy(i)
        wt_signal := true
        break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE SIGNALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// STAGE 1: Stochastic RSI cross (with sustained momentum) + MFI uptrend
stage1 = stoch_signal and mfi_uptrend

// STAGE 2: WaveTrend cross in oversold
stage2 = wt_signal

// FULL BUY: Both stages active
buy_signal = stage1 and stage2

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOT BUY SIGNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotshape(buy_signal and not buy_signal[1], 
          title="BUY", 
          location=location.belowbar, 
          style=shape.labelup, 
          size=size.normal, 
          color=#00b894,
          text="BUY",
          textcolor=color.white)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG PLOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Show Stage 1 signals (teal diamond below bar)
plotshape(show_debug and stage1 and not stage1[1], 
          title="Stage1 Signal", 
          location=location.belowbar, 
          style=shape.diamond, 
          size=size.tiny, 
          color=#fdcb6e)

// Show Stage 2 signals (purple diamond above bar)
plotshape(show_debug and stage2 and not stage2[1], 
          title="Stage2 Signal", 
          location=location.abovebar, 
          style=shape.diamond, 
          size=size.tiny, 
          color=#a29bfe)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG - Check each condition separately
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Current bar conditions (for debug display)
curr_k = k_line[0]
curr_d = d_line[0]
prev_k = k_line[1]
prev_d = d_line[1]
prev_prev_k = k_line[2]

// Individual conditions for bar 0
debug_cross_up = (prev_k <= prev_d) and (curr_k > curr_d)
debug_oversold = (curr_k < stoch_oversold) or (curr_d < stoch_oversold) or (prev_k < stoch_oversold) or (prev_d < stoch_oversold)
debug_k_rising_1d = curr_k > prev_k
debug_k_rising_2d = (curr_k > prev_k) and (prev_k > prev_prev_k)
debug_d_stable = curr_d >= (prev_d * 0.9)

// Check each bar in lookback for cross
cross_bar0 = (k_line[1] <= d_line[1]) and (k_line[0] > d_line[0])
cross_bar1 = (k_line[2] <= d_line[2]) and (k_line[1] > d_line[1])
cross_bar2 = (k_line[3] <= d_line[3]) and (k_line[2] > d_line[2])

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG TABLE (Clean UI)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table info = table.new(position.top_right, 2, 10, 
     bgcolor=color.new(#1a1a2e, 10), 
     border_width=1, 
     border_color=color.new(#4a4a6a, 50),
     frame_width=2,
     frame_color=color.new(#6c5ce7, 80))

if barstate.islast and show_debug
    // Header
    table.cell(info, 0, 0, "ğŸ“Š WAVETREND SCREENER", text_color=#a29bfe, text_size=size.normal, bgcolor=color.new(#2d2d44, 20))
    table.cell(info, 1, 0, "", bgcolor=color.new(#2d2d44, 20))
    
    // Stoch RSI Section
    table.cell(info, 0, 1, "Stoch K/D", text_color=#dfe6e9, text_size=size.small)
    k_d_color = curr_k < 20 or curr_d < 20 ? #00cec9 : #b2bec3
    table.cell(info, 1, 1, str.tostring(curr_k, "#.1") + " / " + str.tostring(curr_d, "#.1"), text_color=k_d_color, text_size=size.small)
    
    // Cross Status
    any_cross = cross_bar0 or cross_bar1 or cross_bar2
    table.cell(info, 0, 2, "Cross", text_color=#dfe6e9, text_size=size.small)
    table.cell(info, 1, 2, any_cross ? "âœ“" : "â€”", text_color=any_cross ? #00b894 : #636e72, text_size=size.small)
    
    // Stoch Signal
    table.cell(info, 0, 3, "Stoch Signal", text_color=#dfe6e9, text_size=size.small)
    table.cell(info, 1, 3, stoch_signal ? "âœ“ Active" : "â€”", text_color=stoch_signal ? #00b894 : #636e72, text_size=size.small)
    
    // MFI Section
    table.cell(info, 0, 4, "MFI", text_color=#dfe6e9, text_size=size.small)
    table.cell(info, 1, 4, str.tostring(mfi_val[0], "#.1"), text_color=#74b9ff, text_size=size.small)
    
    table.cell(info, 0, 5, "MFI Trend", text_color=#dfe6e9, text_size=size.small)
    table.cell(info, 1, 5, mfi_uptrend ? "â†‘ Rising" : "â€” Flat", text_color=mfi_uptrend ? #00b894 : #636e72, text_size=size.small)
    
    // WaveTrend Section
    table.cell(info, 0, 6, "WT1/WT2", text_color=#dfe6e9, text_size=size.small)
    wt_color = wt1 < -53 or wt2 < -53 ? #00cec9 : #b2bec3
    table.cell(info, 1, 6, str.tostring(wt1, "#.1") + " / " + str.tostring(wt2, "#.1"), text_color=wt_color, text_size=size.small)
    
    // Separator
    table.cell(info, 0, 7, "â”€â”€â”€â”€â”€â”€â”€â”€â”€", text_color=#4a4a6a, text_size=size.small)
    table.cell(info, 1, 7, "â”€â”€â”€â”€â”€â”€â”€â”€â”€", text_color=#4a4a6a, text_size=size.small)
    
    // Stage Results
    table.cell(info, 0, 8, "STAGE 1", text_color=#fdcb6e, text_size=size.small)
    table.cell(info, 1, 8, stage1 ? "âœ“ READY" : "âœ—", text_color=stage1 ? #00b894 : #d63031, text_size=size.small)
    
    table.cell(info, 0, 9, "STAGE 2", text_color=#fdcb6e, text_size=size.small)
    table.cell(info, 1, 9, stage2 ? "âœ“ READY" : "âœ—", text_color=stage2 ? #00b894 : #d63031, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(buy_signal and not buy_signal[1], 
               title="ğŸš¨ BUY SIGNAL", 
               message="ğŸš¨ {{ticker}} BUY @ {{close}}")

alertcondition(stage1 and not stage1[1], 
               title="Stage 1 Active", 
               message="{{ticker}} Stage 1: Stoch RSI + MFI âœ“")

alertcondition(stage2 and not stage2[1], 
               title="Stage 2 Active", 
               message="{{ticker}} Stage 2: WaveTrend âœ“")
